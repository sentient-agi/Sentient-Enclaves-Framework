<h1 align="center">Sentient Enclaves Framework</h1>

<!-- Socials -->
<p align="center">
      <a href="https://sentient.xyz/" target="_blank" style="margin: 2px;">
    <img alt="Homepage" src="https://img.shields.io/badge/Website-Sentient.xyz-%23EAEAEA?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNDEuMzMzIiBoZWlnaHQ9IjM0MS4zMzMiIHZlcnNpb249IjEuMCIgdmlld0JveD0iMCAwIDI1NiAyNTYiPjxwYXRoIGQ9Ik0xMzIuNSAyOC40Yy0xLjUgMi4yLTEuMiAzLjkgNC45IDI3LjIgMy41IDEzLjcgOC41IDMzIDExLjEgNDIuOSAyLjYgOS45IDUuMyAxOC42IDYgMTkuNCAzLjIgMy4zIDExLjctLjggMTMuMS02LjQuNS0xLjktMTcuMS03Mi0xOS43LTc4LjYtMS4yLTMtNy41LTYuOS0xMS4zLTYuOS0xLjYgMC0zLjEuOS00LjEgMi40ek0xMTAgMzBjLTEuMSAxLjEtMiAzLjEtMiA0LjVzLjkgMy40IDIgNC41IDMuMSAyIDQuNSAyIDMuNC0uOSA0LjUtMiAyLTMuMSAyLTQuNS0uOS0zLjQtMi00LjUtMy4xLTItNC41LTItMy40LjktNC41IDJ6TTgxLjUgNDYuMWMtMi4yIDEuMi00LjYgMi44LTUuMiAzLjctMS44IDIuMy0xLjYgNS42LjUgNy40IDEuMyAxLjIgMzIuMSAxMC4yIDQ1LjQgMTMuMyAzIC44IDYuOC0yLjIgNi44LTUuMyAwLTMuNi0yLjItOS4yLTMuOS0xMC4xQzEyMy41IDU0LjIgODcuMiA0NCA4NiA0NGMtLjMuMS0yLjMgMS00LjUgMi4xek0xNjUgNDZjLTEuMSAxLjEtMiAyLjUtMiAzLjIgMCAyLjggMTEuMyA0NC41IDEyLjYgNDYuNS45IDEuNSAyLjQgMi4zIDQuMiAyLjMgMy44IDAgOS4yLTUuNiA5LjItOS40IDAtMS41LTIuMS0xMC45LTQuNy0yMC44bC00LjctMTguMS00LjUtMi44Yy01LjMtMy40LTcuNC0zLjYtMTAuMS0uOXpNNDguNyA2NS4xYy03LjcgNC4xLTYuOSAxMC43IDEuNSAxMyAyLjQuNiAyMS40IDUuOCA0Mi4yIDExLjYgMjIuOCA2LjIgMzguOSAxMC4yIDQwLjMgOS44IDMuNS0uOCA0LjYtMy44IDMuMi04LjgtMS41LTUuNy0yLjMtNi41LTguMy04LjJDOTQuMiA3My4xIDU2LjYgNjMgNTQuOCA2M2MtMS4zLjEtNCAxLTYuMSAyLjF6TTE5OC4yIDY0LjdjLTMuMSAyLjgtMy41IDUuNi0xLjEgOC42IDQgNS4xIDEwLjkgMi41IDEwLjktNC4xIDAtNS4zLTUuOC03LjktOS44LTQuNXpNMTgxLjggMTEzLjFjLTI3IDI2LjQtMzEuOCAzMS41LTMxLjggMzMuOSAwIDEuNi43IDMuNSAxLjUgNC40IDEuNyAxLjcgNy4xIDMgMTAuMiAyLjQgMi4xLS4zIDU2LjktNTMuNCA1OS01Ny4xIDEuNy0zLjEgMS42LTkuOC0uMy0xMi41LTMuNi01LjEtNC45LTQuMi0zOC42IDI4Ljl6TTM2LjYgODguMWMtNSA0LTIuNCAxMC45IDQuMiAxMC45IDMuMyAwIDYuMi0yLjkgNi4yLTYuMyAwLTIuMS00LjMtNi43LTYuMy02LjctLjggMC0yLjYuOS00LjEgMi4xek02My40IDk0LjVjLTEuNi43LTguOSA3LjMtMTYuMSAxNC43TDM0IDEyMi43djUuNmMwIDYuMyAxLjYgOC43IDUuOSA4LjcgMi4xIDAgNi0zLjQgMTkuOS0xNy4zIDkuNS05LjUgMTcuMi0xOCAxNy4yLTE4LjkgMC00LjctOC40LTguNi0xMy42LTYuM3pNNjIuOSAxMzAuNiAzNCAxNTkuNXY1LjZjMCA2LjIgMS44IDguOSA2IDguOSAzLjIgMCA2Ni02Mi40IDY2LTY1LjYgMC0zLjMtMy41LTUuNi05LjEtNi4ybC01LS41LTI5IDI4Ljl6TTE5Ni4zIDEzNS4yYy05IDktMTYuNiAxNy4zLTE2LjkgMTguNS0xLjMgNS4xIDIuNiA4LjMgMTAgOC4zIDIuOCAwIDUuMi0yIDE3LjktMTQuOCAxNC41LTE0LjcgMTQuNy0xNC45IDE0LjctMTkuMyAwLTUuOC0yLjItOC45LTYuMi04LjktMi42IDAtNS40IDIuMy0xOS41IDE2LjJ6TTk2IDEzNi44Yy0yLjkuOS04IDYuNi04IDkgMCAxLjMgMi45IDEzLjQgNi40IDI3IDMuNiAxMy42IDcuOSAzMC4zIDkuNyAzNy4yIDEuNyA2LjkgMy42IDEzLjMgNC4xIDE0LjIuNSAxIDIuNiAyLjcgNC44IDMuOCA2LjggMy41IDExIDIuMyAxMS0zLjIgMC0zLTIwLjYtODMuMS0yMi4xLTg1LjktLjktMS45LTMuNi0yLjgtNS45LTIuMXpNMTIwLjUgMTU4LjRjLTEuOSAyLjktMS4yIDguNSAxLjQgMTEuNiAxLjEgMS40IDEyLjEgNC45IDM5LjYgMTIuNSAyMC45IDUuOCAzOC44IDEwLjUgMzkuOCAxMC41czMuNi0xIDUuNy0yLjJjOC4xLTQuNyA3LjEtMTAuNi0yLjMtMTMuMi0yOC4yLTguMS03OC41LTIxLjYtODAuMy0yMS42LTEuNCAwLTMgMS0zLjkgMi40ek0yMTAuNyAxNTguOGMtMS44IDEuOS0yLjIgNS45LS45IDcuOCAxLjUgMi4zIDUgMy40IDcuNiAyLjQgNi40LTIuNCA1LjMtMTEuMi0xLjUtMTEuOC0yLjQtLjItNCAuMy01LjIgMS42ek02OS42IDE2MmMtMiAyLjItMy42IDQuMy0zLjYgNC44LjEgMi42IDEwLjEgMzguNiAxMS4xIDM5LjkgMi4yIDIuNiA5IDUuNSAxMS41IDQuOSA1LTEuMyA0LjktMy0xLjUtMjcuNy0zLjMtMTIuNy02LjUtMjMuNy03LjItMjQuNS0yLjItMi43LTYuNC0xLjctMTAuMyAyLjZ6TTQ5LjYgMTgxLjVjLTIuNCAyLjUtMi45IDUuNC0xLjIgOEM1MiAxOTUgNjAgMTkzIDYwIDE4Ni42YzAtMS45LS44LTQtMS44LTQuOS0yLjMtMi4xLTYuNi0yLjItOC42LS4yek0xMjguNSAxODdjLTIuMyAyLjUtMS4zIDEwLjMgMS42IDEyLjggMi4yIDEuOSAzNC44IDExLjIgMzkuNCAxMS4yIDMuNiAwIDEwLjEtNC4xIDExLTcgLjYtMS45LTEuNy03LTMuMS03LS4yIDAtMTAuMy0yLjctMjIuMy02cy0yMi41LTYtMjMuMy02Yy0uOCAwLTIuMy45LTMuMyAyek0xMzYuNyAyMTYuOGMtMy40IDMuOC0xLjUgOS41IDMuNSAxMC43IDMuOSAxIDguMy0zLjQgNy4zLTcuMy0xLjItNS4xLTcuNS03LjEtMTAuOC0zLjR6Ii8%2BPC9zdmc%2B&link=https%3A%2F%2Fhuggingface.co%2FSentientAGI"/>
  </a>
  <!-- Github Repo Info -->
    <!-- Release -->
    <a href="https://github.com/sentient-agi/Sentient-Enclaves-Framework/releases/tag/v0.8.1">
        <img alt="GitHub release" src="https://img.shields.io/badge/Release-v0.8.1-green">
    </a>
    <!-- License -->
    <a href="./LICENSE-APACHE">
        <img alt="License" src="https://img.shields.io/badge/License-Apache_2.0-blue">
    </a>
    <!-- status as beta -->
    <a>
        <img alt="GitHub release" src="https://img.shields.io/badge/Release_Status-Beta-yellow">
    </a>
</p>

<p align="center">
  <img src="docs/png/banner.png" alt="Sentient Enclaves Framework - Confidential Computing Infrastructure Banner"/>
</p>

Welcome to the Sentient Enclaves Framework. The framework provides end-to-end infrastructure for building confidential AI applications using TEEs.


# List Of Contents üìö


- [DETAILED PROJECT COMPONENTS EXPLANATION](docs/md/REFERENCE_README.md)


- [DIAGRAMS](docs/md/REFERENCE_README.md#visualization-of-sentient-enclaves-framework-infrastructure-components-and-its-interaction-with-diagrams)


- [GETTING STARTED (QUICK START) GUIDE](docs/md/BUILDING.md)


- [USAGE AND ADVANCED USAGE GUIDE](docs/md/USAGE.md)


- [ATTESTATION WEB API PROTOCOL SPECIFICATION](docs/md/ATTESTATION_WEB_API.md)


- [OPENSSL STATIC BUILD GUIDE](docs/md/OPENSSL_BUILD.md)


- [DEMONSTRATIONS](docs/md/REFERENCE_README.md#demonstrations)


- [REFERENCE APPLICATIONS BUILT WITH FRAMEWORK](reference_apps/)


- [CHANGELOG](docs/md/CHANGELOG.md)


- [ROADMAP](docs/md/ROADMAP.md)


- [LICENSE](LICENSE)


# Overview üîç

Trusted Execution Environments (TEEs, aka Confidential Computing Environments) are a type of hardware-based security mechanism
that allows for the secure execution of code in a protected environment (hardware isolated memory area).
TEEs are designed to provide a secure and isolated execution environment for applications that handling sensitive data (data-sets), such as AI models, by ensuring that the code and data are protected from any unauthorized external access.
This framework provides a comprehensive infrastructure for building confidential AI applications using AWS's [Nitro Enclaves](https://aws.amazon.com/ec2/nitro/nitro-enclaves/) offering.
The framework enables the creation of confidential enclaves that are isolated from the host machine and operator (cloud provider) infrastructure.


# Features üî•

- Seamlessly setup and deploy confidential AI applications in TEEs üöÄ
- Generate reproducible builds and verifiable build hashes for enclave image and applications üîê
- Access internet services inside isolated enclave using forward proxies üîå
- Deploy internet-facing applications inside enclave using reverse proxies üåê
- Verify enclave application integrity at runtime using PCR-based attestation üõ°Ô∏è
- Ensure the integrity of external data through hash and VRF proof verification üìÑüîí


# Framework Components üèóÔ∏è
To allow for the creation of confidential AI applications set of infrastructure components are needed. The framework abstracts these components away from the developer, providing a simple interface for building confidential AI applications. Framework provides following components:

| Component    | Description                                                                     | Functionality                                                                                                                                                                                                                                                               | Documentation                                                                                                                                                                          |
|--------------|---------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `pipeline`   | Implementation of binary protocol over `vsock` for interacting with enclave     | Controls enclave execution and enables bi-directional file transfers                                                                                                                                                                                                        | [![Documentation](https://img.shields.io/badge/Pipeline_SLC-Docs-blue)](docs/md/REFERENCE_README.md#pipeline-slc-vsock-communication-protocol)                                             |
| `rbuilds.sh` | Script utilising set of components for building reproducible enclave images     | Enables byte-level reproducibility for enclave images and streamlines the build process                                                                                                                                                                                     | [![Documentation](https://img.shields.io/badge/Reproducible_Builds_System-Docs-blue)](docs/md/REFERENCE_README.md#build-system-for-enclaves-reproducible-builds)                       |
| `pf-proxy`   | Transparent `vsock` proxies for internet-enabled applications                   | Provides full networking stack support, enabling outbound TCP connections using forward proxies and inbound TCP connections using reverse proxies for enclaves                                                                                                              | [![Documentation](https://img.shields.io/badge/PF_Proxy-Docs-blue)](docs/md/REFERENCE_README.md#transparent-vsock-proxies)                                                             |
| `ra-web-srv` | Remote Attestation Web Server for verifying integrity of applications           | Enables remote attestation of EIF base image and enclave file system, verifying static and run-time integrity via PCR hash comparison and per-file proofs from within the enclave.                                                                                          | [![Documentation](https://img.shields.io/badge/Attestation_Web_Server-Docs-blue)](docs/md/REFERENCE_README.md#web-server-and-web-protocol-for-remote-attestation-of-enclaves-run-time) |
| `fs-monitor` | Real-time `inotify` events monitoring server for changes of files & directories | Covering per file (and directory) changes in enclave's ramdisk FS using files hashing. It emulates CoW FS layer for tracking any changes in enclave's run-time file system and acting as a data provider about granular FS changes for attestation web server and protocol. | [![Documentation](https://img.shields.io/badge/FS_Monitor-Docs-blue)](docs/md/REFERENCE_README.md#enclaves-file-system-monitor)                                                        |


### Project Diagram:

> [!NOTE]
> #### More details about these components and other framework components that are under development can be found in the [Detailed project reference README](docs/md/REFERENCE_README.md).
>

<p align="center">
  <img src="docs/svg/TEE-Infra-2025-01-09-1700.excalidraw.svg"/>
  <h3 align="center">Figure 1: Shows overall framework architecture and interactions between components</h3>
</p>

# Getting Started üöÄ

## Building the components
### Prerequisites üìã
- [Nitro-enabled AWS EC2 instance](https://docs.aws.amazon.com/enclaves/latest/user/nitro-enclave.html#nitro-enclave-reqs)
- [Docker](https://docs.docker.com/get-docker/)

### Building core components of the framework üõ†Ô∏è
Building the core components of the framework is done using the `rbuilds.sh` script. This script simplifies the process of building the components and handles all the dependencies. Exact steps are available in the [BUILDING.md](docs/md/BUILDING.md) file.

### Building and running apps ‚ö°
Once the core components are built, the apps can be built and run using the `rbuilds.sh` script. [Reference apps](reference_apps/) directory contains example applications that utilize the framework. Each reference application follows the following structure:

```
reference_apps/
‚îú‚îÄ‚îÄ reference_app_name : Name of the reference application
‚îÇ   ‚îú‚îÄ‚îÄ reference_app_name.dockerfile : Template Dockerfile for building the application with necessary dependencies to run inside enclave
‚îÇ   ‚îú‚îÄ‚îÄ TEE_rbuilds_setup.md: Application setup guide for building and running the application using rbuilds.sh
‚îÇ   ‚îú‚îÄ‚îÄ TEE_setup.md: Legacy setup guide
```

To run any of the reference applications, the steps outlined in the respective `TEE_rbuilds_setup.md` should be followed.

## Enclave Attestation üõ°Ô∏è

Ensuring the integrity and authenticity of the code and data running within a confidential computing environment is crucial. The Sentient Enclaves Framework provides built-in mechanisms to verify the state of your application running inside the Nitro Enclave.

This involves two primary aspects facilitated by the `ra-web-srv` component:

### Verifying External Data Integrity
Confirming that any configuration or input files loaded by the enclave application have not been tampered with. The `ra-web-srv` component, running inside the enclave, can generate cryptographic hashes and Verifiable Random Function (VRF) proofs for specified files.

  > [!IMPORTANT]
  > The RA server runs inside the enclave and is accessible via `curl` only if *reverse proxy* is enabled. Make sure to enable reverse proxy by using `--network` flag while building the enclave and `eif` file. Otherwise, use `pipeline` utility to interact with the RA server.

  #### 1. Generate proofs for a file:
  ```bash
  curl -s -i -k -X POST -H 'Content-Type: application/json' -d '{ "path": "/path/to/file" }' https://127.0.0.1:8443/generate
  ```
  > [!NOTE]
  > While using `pipeline` utility for requesting proofs, make sure to escape the `"` using `\"` in the `-d` parameter. This escaping might be required for some shells.

  #### 2. Retrieve the generated proof:
  ```bash
  curl -s -i -k -X GET https://127.0.0.1:8443/proof/?path=/path/to/file
  ```
  You would then compare the received hash with a locally computed hash of your expected file content to verify integrity of enclave's external data.

### Validating the Application's Base Image
Verifying that the exact expected Enclave Image File (`.eif`) is running. This is done by comparing the runtime Platform Configuration Register (PCR) values of the running enclave (obtained via the `ra-web-srv`) with the PCR values of the `.eif` file from which the enclave was launched (obtained using `nitro-cli`).

  #### 1. Retrieve the enclave's attestation document containing runtime PCRs:
  > [!NOTE]
  > Make sure that the path is the same as the path to the file used to generate the proof.
  ```bash
  curl -s -i -k -X GET https://127.0.0.1:8443/doc/?path=/path/to/file/&view=json_hex
  ```
  #### 2. Obtain the reference PCRs from the original EIF file:
  ```bash
  nitro-cli describe-eif --eif-path /path/to/your/app.eif
  ```
  Amongst the returned data, the `PCR0`, `PCR1`, `PCR2` values contains following measurements:

**`PCR0`**:
- `PCR0` contains a measurement of all the data influencing the runtime of code in an EIF
- `PCR0` = `SHA384(KERNEL | Cmdline | Ramdisk(init) | Ramdisk(1:))`
> [!NOTE]
> The `Ramdisk(1:)` is the path to the all of user application's data in the `.eif` file except the `init` process.

**`PCR1`**:
- `PCR1` contains a measurement of all the data influencing the bootstrap and kernel in an EIF.
- `PCR1` = `SHA384(Kernel | Initramfs | Cmdline | Ramdisk(init))`

**`PCR2`**:
- `PCR2` contains a measurement of the user application in an EIF
- `PCR2` = `SHA384(Ramdisk(1:))`

Matching these PCRs (`PCR0`, `PCR1`, `PCR2`) confirms the integrity of the base image running in the enclave.

> [!IMPORTANT]
> To obtain valid and verifiable attestation results, ensure that your enclave is running in `non-debug` mode. In `debug` mode, Platform Configuration Register (PCR) values are not set and will appear as all zeros when queried. This prevents meaningful attestation. Only in `non-debug` mode are the PCR values computed from the Enclave Image Format (`.eif`) before boot and set correctly to reflect the enclave‚Äôs configuration and integrity.
For complete, detailed instructions on how to perform these attestation steps for [X_Agent](./reference_apps/X_Agent/), please refer to the [X Agent Enclave Attestation Section](./reference_apps/X_Agent/TEE_rbuilds_setup.md#verifying-x_agent-integrity-within-the-enclave-Ô∏è).


# Directory Structure üìÅ
Project follows the directory structure given below:
```
sentient-enclaves-framework/
‚îú‚îÄ‚îÄ pipeline : source code for pipeline component for interacting with enclaves
‚îú‚îÄ‚îÄ pf-proxy : Source code for transparent vsock proxies for internet-enabled applications
‚îú‚îÄ‚îÄ rbuilds
‚îÇ   ‚îú‚îÄ‚îÄ*.dockerfile : Dockerfile used for different stages while building enclave images
‚îÇ   ‚îú‚îÄ‚îÄ rbuilds.sh: Script for building reproducible enclave images
‚îú‚îÄ‚îÄ rbuilds.legacy : Legacy build system for building enclave images. Currently not used.
‚îú‚îÄ‚îÄ reference_apps : Reference applications that utilize the framework
‚îÇ   ‚îú‚îÄ‚îÄ fingerprinting_server : A model fingerprinting server that fingerprints models based on OML fingerprinting library
‚îÇ   ‚îú‚îÄ‚îÄ inference_server : An inference server that uses a local model inference
‚îÇ   ‚îú‚îÄ‚îÄ X_Agent : A reference agent that interacting with X users
‚îú‚îÄ‚îÄ ra-web-srv : Web Server for remote attestation of enclaves
‚îú‚îÄ‚îÄ fs-monitor : Real-time `inotify` events monitoring server for changes of files & directories in enclave's ramdisk FS
‚îî‚îÄ‚îÄ docs : Detailed documentation for the framework and its components
```

# Contributing ü§ù
> [!IMPORTANT]
> Contributions are welcome! Contribution guidelines will soon be available.

# License üìù
This project is licensed under the [Apache 2.0 License](LICENSE-APACHE).


<p align="center">
  <img src="docs/png/banner.png"/>
</p>
<p align="center">
  <!-- Web-site -->
  <a href="https://sentient.xyz" target="_blank" style="margin: 2px;">
    <img alt="Homepage" src="https://img.shields.io/badge/Website-Sentient.xyz-%23FD698D.svg?style=for-the-badge&logo=data:image/webp;base64,UklGRqIGAABXRUJQVlA4IJYGAACQLQCdASrIAMgAPjEYikOiIaEULlwAIAMEsrdwuaCBqL/2n4zeGJYfxn4zfjJ0KPAngL+Q/9X+39CydrsW+u/zP9vv538GP6J+Un8A+m/mAfof/eP5B13f416Bf5F/Fv7v/Zv3/+Wb/Ff3L+we5T8JfcA/mX8p67P9APYX/g/8N///rCfq78LH7rfqN7GH/2uyFdf6C+1HabyDi2MyKk0nyEvYRwmrlISWRUwzWVIPJZFTDNZUg8lkUBS10N65+7oyTCaCfVFWxr/zTaq/tciIwh3fNKTP/KauqRjueIKw9XpaY6IdHLsslK+W7eJLb42dDjvaiRqii5+vlX1UEt1B20ksiiCNbRCKc2Sblj5ZKypkkgNKvuxwrSKEpH2npe8w8hUU2ClOK5aPSF6ExebM2ro3wg8ktwFDtfLuM3e6y2rWzNls7wCj7WXGRsFs1lRbwikMnjOydX9+NsKNMapH276+Xky6/vt3yayyqr++3fJrLJIAAP79y+aEIaPDfzcv4wX8YKEaBMwQAAAApstX7y10SoxrMXC7S0LDg2lT6p0L8LbVjzCwg/bWpX/kUkW7SnO252UrP2pz3BRQm37vC+c4CU2eKAiYk//FS9nXbdh5qYIhk5Mao3CzFz8kEaJBRcAsLZ/oYJwsZXSHjmqWn8IcniJ31/x11NclDk5TvnyGDAuoJuUVqX+3BMIf8JV0VWtNdAh1pQG/9F2KxmkjA5R3BTn6NP/6G4gPs6kNR2GWTNHVtFT8ZWNvLYPLBePEEG5BRqCKnNTJxfplM+A7R3GIoKmC2Nz21irxPefRb1UCXNRtT9yptuz2E58tOrw82zvexvPM4FzwFJe/umSdhL4A/VAqkxQNKrVu9/pnF2BdnDnhryxmwFt6e7QEV0VAoNc5st40/GgOcH6NA+s06FzLe5IpfxdqAn2eyASd+xrxVdFoH5othlag7g5HX7rESenO3L3Q9LELFzp/5ubEHN33IkYprUTh6aI3gnyJ/22dz5fRfBlYQJIaqa7sta6FZ1mjWQ3IfC25cMf/PAVxXMKs2s0NtHHBqTMl+4kL07i05Pl6zRmlHVp4UPSbDSBGFT8xVyF850HZoNxH12DWrX1nU6VuGG1zPNdM1oFnhq1PvMy0gMynNBp5jgN3HhzEnl/gCM/JHlC4qO+urit2lNl8+59T+7lZQLi73SXnfk2w0csb1jUb/tobN5Wk61zZRYz+ge8F/5nFbLsSRG4+Uhn5JKm0tVoBMWgkjxLSnZ5xW5I5ct+NPt84ocbeGoQC6fuI6MjFmQheyTuhB1wq//qqMdYBAcJTauaWSGf878gcRcJhTtxOZXUxgYKmwbcUDECVaPQcfrQiZnsEmMpiG1Xdm+oGoRaEb5+Z8WvxC9XY0LmLPg+PhdLyknpvaFD2ks3AIKvbTtUJaia9OKL0/cR8nyKMi3kjB0xAWUukbcr7s0KIV3JZfizxQqpw6WMWXJyuLz2AlYfNjqx/9l0gG6AB43zGDqKMMstnj/4E/LaViesMKVhivnR7zfy/ZuoAoMijKpmtR4PDcgMkYLOm5bG1yCaof1L7O9lTYTLZ1BG94OIDPhrPsRFOpl1Pcqxr2L5nADGNX8FSqdtFoLbllTpWL1H5XugXkXBiJGLYdzvo2x3tuQe/0eOKn+f9ltVeC3hE5i//1j51O7lZXE5gHL6tuQQ7SfNWW8I+smX3K+4NP06gGbBctf/qD9w2AuUR3x5vxbQMPTrvK2QA0kFa+HtkTvRcMLZsCx7X1L8Y78KYCtWhmsLH4ucEHP+tbYAVEkrdB3b/2aMQKOguBn6CHTOpMhptmjhiVxyNXTlx9mj3zkwdgMzk0FJLOkGLdzrOq1s+x0k61QuNu+kV3R/Xc63iz81y8k4Bvz58w+yaju3YJLdZ7bnxR4YTwarO78rQFGsPj9DM5pQkLn78S1KzGFBB2MJ9WJCyGcn4s2xEc1JU63gM5PESbWVi7AlOTfUhEI8AqAsFIB51Xy0erIkuVibfq8wFy5PRIYev99vbwf4VyQrpamz+Znq2ByGntFa5VLSbp5F3/Ug1xjKi3Rh5kvNo2UTOfN2DZYE4R7sdw2qhqfTVHC62oHEx97Jr0OSl0qvHxUrvPqxDM0hmLN3ROQ7D0A3XWQkVNsIOJpQFwLp/D5QL61ODczFQDjNNTtFQZW4T5PtLzqrVnr/p23TiM7nI5OGa6dLUITb9+lbITiq0iULHCkJl9WyNGZOcmoqAAAAAAAA="/>
  </a>
  <!-- Github Repo Info -->
    <!-- Release -->
    <a href="https://github.com/sentient-agi/sentient-enclaves-framework/releases">
        <img alt="GitHub release" src="https://img.shields.io/badge/dynamic/json?url=https%3A%2F%2Fapi.github.com%2Frepos%2Fsentient-agi%2Fsentient-enclaves-framework%2Ftags&query=%24.0.name&style=for-the-badge&label=Release&color=darkgreen">
    </a>
    <!-- status as beta -->
    <a>
        <img alt="GitHub release" src="https://img.shields.io/badge/Release_Status-Beta-orange.svg?style=for-the-badge">
    </a>
    <!-- Rust Toolchain version -->
    <a href="./rust-toolchain">
        <img alt="Rust Toolchain" src="https://img.shields.io/badge/dynamic/toml?url=https%3A%2F%2Fraw.githubusercontent.com%2Fsentient-agi%2Fsentient-enclaves-framework%2Fmain%2Frust-toolchain&query=%24.toolchain.channel&prefix=1.91%20&style=for-the-badge&label=Rust%20Toolchain&color=darkviolet">
    </a>
    <!-- License -->
    <a href="./LICENSE-APACHE">
        <img alt="License" src="https://img.shields.io/badge/License-Apache_2.0-blue.svg?style=for-the-badge">
    </a>
</p>

# Sentient Enclaves Framework

<p align="center">
  <strong>A Comprehensive Trusted Execution Environment (TEE) Framework for Secure AI and Cryptographic Applications</strong>
</p>

<p align="center">
  <a href="#overview">Overview</a> â€¢
  <a href="#architecture">Architecture</a> â€¢
  <a href="#quick-start">Quick Start</a> â€¢
  <a href="#components">Components</a> â€¢
  <a href="#build-system">Build System</a> â€¢
  <a href="#cli-reference">CLI Reference</a> â€¢
  <a href="#api-reference">API Reference</a> â€¢
  <a href="#configuration">Configuration</a> â€¢
  <a href="#security">Security</a> â€¢
  <a href="#troubleshooting">Troubleshooting</a>
</p>

---

## Overview

The **Sentient Enclaves Framework** is a production-grade, security-focused framework designed for building, deploying, and managing applications within AWS Nitro Enclaves. It provides comprehensive tooling for secure computation in Trusted Execution Environments (TEEs), enabling:

- **Confidential AI Inference**: Run AI models in isolated, attestable environments
- **Secure Cryptographic Operations**: Perform sensitive operations with hardware-backed isolation
- **Remote Attestation**: Cryptographically prove the integrity of enclave workloads
- **Secure Communication**: Encrypted channels between host and enclave via VSOCK

### Key Features

| Feature | Description |
|---------|-------------|
| ðŸ” **Hardware Isolation** | Leverages AWS Nitro Enclaves for hardware-level memory isolation |
| ðŸ“ **Remote Attestation** | Cryptographic proof of enclave state with VRF proofs and NSM integration |
| ðŸ”„ **Secure Communication** | VSOCK-based Pipeline protocol for host-enclave communication |
| ðŸŒ **Network Proxying** | Bidirectional port forwarding between host network and enclave |
| ðŸ“¦ **Reproducible Builds** | Deterministic EIF image generation with consistent PCR values |
| ðŸ› ï¸ **Custom Init System** | Lightweight service manager with dependency resolution |
| ðŸ“Š **File System Monitoring** | Real-time integrity monitoring with NATS integration |

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HOST EC2 INSTANCE                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Pipeline CLI   â”‚  â”‚  PF-Proxy (FW)  â”‚  â”‚  PF-Proxy (RV)  â”‚          â”‚
â”‚  â”‚    (Client)     â”‚  â”‚   Host-side     â”‚  â”‚   Host-side     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚ VSOCK              â”‚ VSOCK              â”‚ VSOCK             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â”‚                    â”‚                    â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     AWS NITRO ENCLAVE                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                    enclave-init (PID 1)                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚         Service Manager with Dependency Resolution          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Pipeline    â”‚  â”‚  ra-web-srv   â”‚  â”‚     fs-monitor        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   (Server)    â”‚  â”‚  (HTTPS API)  â”‚  â”‚  (inotify+NATS)       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  NATS Server  â”‚  â”‚ PF-Proxy(FW)  â”‚  â”‚    PF-Proxy(RV)       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (Event Bus)   â”‚  â”‚  Guest-side   â”‚  â”‚    Guest-side         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚           NSM (Nitro Security Module) Interface             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    Attestation Documents â€¢ RNG â€¢ PCR Registers              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Interactions

1. **Host â†’ Enclave Commands**: Pipeline CLI sends commands via VSOCK
2. **File Integrity**: fs-monitor watches files, publishes hashes to NATS
3. **Attestation**: ra-web-srv generates NSM attestation documents with VRF proofs
4. **Network Access**: PF-Proxy bridges TCP traffic over VSOCK

---

## Quick Start

### Prerequisites

- **EC2 Instance**: Must be a Nitro Enclave-enabled instance type (e.g., `c5.xlarge`, `m5.2xlarge`)
- **Operating System**: Amazon Linux 2023 (recommended) or Amazon Linux 2
- **Rust**: Version 1.91.1 or later
- **Docker**: For build environment isolation

### 1. System Setup

```bash
# Clone the repository
git clone https://github.com/sentient-agi/sentient-enclaves-framework.git
cd sentient-enclaves-framework/rbuilds

# Install Nitro Enclaves CLI and allocate resources
./rbuilds.sh --cmd "make_nitro"

# Reboot to apply Nitro Enclaves allocator changes
sudo reboot
```

### 2. Build Everything

```bash
# Full automated build (kernel, apps, init, EIF image)
mkdir -vp ./eif/
./rbuilds.sh --tty --debug --network --init-c --cmd "make_all" 2>&1 3>&1
```

### 3. Run the Enclave

```bash
# Launch enclave in debug mode with attached console
./rbuilds.sh --tty --debug --network --init-c --cmd "run_eif_image_debugmode_cli" 2>&1 3>&1
```

### 4. Interact with the Enclave

```bash
# From host: Execute command inside enclave
./pipeline run -- ls -la /apps/

# Send file to enclave
./pipeline send-file ./local-data.txt /apps/data.txt

# Receive file from enclave
./pipeline recv-file /apps/results.txt ./local-results.txt
```

---

## Components

### Pipeline - Secure Local Channel Protocol

**Location**: `pipeline/`

The Pipeline component provides secure, encrypted communication between host and enclave via VSOCK.

#### Features
- Command execution inside enclave
- Bidirectional file transfer
- Cryptographic channel security
- Asynchronous operation modes

#### Usage

```bash
# Start server (inside enclave)
pipeline listen --port 53000

# Execute command (from host)
pipeline run --cid 127 --port 53000 -- /usr/bin/app --flag value

# File operations
pipeline send-file --cid 127 --port 53000 ./input.bin /apps/input.bin
pipeline recv-file --cid 127 --port 53000 /apps/output.bin ./output.bin
```

#### Configuration

**File**: `.config/pipeline.config.toml`

```toml
cid = 127
port = 53000
```

---

### Remote Attestation Web Server (ra-web-srv)

**Location**: `ra-web-srv/`

HTTPS REST API for remote attestation services, providing cryptographic proofs of enclave integrity.

#### Features
- SHA3-512 file hashing
- VRF (Verifiable Random Function) proofs
- NSM attestation document generation
- Certificate chain validation
- NATS JetStream persistence

#### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/generate` | POST | Start processing files/directories |
| `/hash/` | GET | Get SHA3-512 hash for file |
| `/proof/` | GET | Get VRF proof for file |
| `/doc/` | GET | Get attestation document |
| `/pcrs/` | GET | Get enclave PCR registers |
| `/verify_hash/` | POST | Verify file hash |
| `/verify_proof/` | POST | Verify VRF proof |
| `/verify_doc/` | POST | Verify attestation document signature |
| `/verify_cert_bundle/` | POST | Verify certificate chain |
| `/pubkeys/` | GET | Get server public keys |
| `/nsm_desc` | GET | Get NSM device description |
| `/rng_seq` | GET | Get cryptographic random bytes |

#### Example Usage

```bash
# Generate attestation for directory
curl -k -X POST https://127.0.0.1:8443/generate \
  -H "Content-Type: application/json" \
  -d '{"path": "/apps/data"}'

# Get file hash
curl -k "https://127.0.0.1:8443/hash/?path=/apps/data/file.txt"

# Get attestation document
curl -k "https://127.0.0.1:8443/doc/?path=/apps/data/file.txt&view=json_hex"

# Verify PCRs against expected values
curl -k -X POST https://127.0.0.1:8443/verify_pcrs/ \
  -H "Content-Type: application/json" \
  -d '{"pcrs": "0: abc123...\n1: def456..."}'
```

#### Configuration

**File**: `.config/ra_web_srv.config.toml`

```toml
[ports]
http = 8080
https = 8443

[keys]
sk4proofs = ""  # Auto-generated if empty
sk4docs = ""

vrf_cipher_suite = "SECP256R1_SHA256_TAI"

[nats]
nats_persistency_enabled = 1
nats_url = "nats://127.0.0.1:4222"
hash_bucket_name = "fs_hashes"
att_docs_bucket_name = "fs_att_docs"
persistent_client_name = "ra_web_srv"
```

---

### Port Forwarding Proxy (pf-proxy)

**Location**: `pf-proxy/`

Bidirectional network proxy bridging TCP connections over VSOCK.

#### Binaries

| Binary | Direction | Description |
|--------|-----------|-------------|
| `ip-to-vsock` | Host â†’ Enclave | Forward host TCP to enclave VSOCK |
| `vsock-to-ip` | Enclave â†’ Host | Forward enclave VSOCK to host TCP |
| `ip-to-vsock-transparent` | Host â†’ Enclave | Transparent TCP forwarding |
| `vsock-to-ip-transparent` | Enclave â†’ Host | Transparent VSOCK forwarding |
| `transparent-port-to-vsock` | Host â†’ Enclave | Port-based transparent proxy |

#### Usage

```bash
# Host side: Forward local port 8080 to enclave
ip-to-vsock --listen-ip 0.0.0.0 --listen-port 8080 \
            --vsock-cid 127 --vsock-port 8080

# Enclave side: Forward VSOCK to internal service
vsock-to-ip --vsock-port 8080 \
            --target-ip 127.0.0.1 --target-port 8080
```

---

### File System Monitor (fs-monitor)

**Location**: `fs-monitor/`

Real-time file system integrity monitoring using inotify events.

#### Features
- Recursive directory monitoring
- Pattern-based file exclusion (`.fsignore`)
- SHA3-512 hashing
- NATS KV persistence
- Debounced event processing

#### Usage

```bash
fs-monitor --directory "/apps/" \
           --ignore-file ".fsignore" \
           --nats-url "nats://127.0.0.1:4222" \
           --kv-bucket-name "fs_hashes"
```

#### Ignore File Format

**File**: `.fsignore`

```
# Comments start with #
*.log
*.tmp
.git/
node_modules/
target/
```

---

### Enclave Init System (enclave-init)

**Location**: `enclave-init/`

Lightweight PID 1 process for managing services inside the enclave.

#### Features
- Service dependency resolution (before, after, requires)
- Automatic service restart policies
- Signal handling (SIGCHLD, SIGTERM, SIGHUP)
- Service logging with rotation
- Control socket (Unix & VSOCK)
- Process management

#### Service File Format

**Location**: `/etc/init.d/*.service`

```toml
[Service]
ExecStart = "/apps/my-service --config /apps/.config/service.toml"
Environment = ["LOG_LEVEL=info", "PORT=8080"]
WorkingDirectory = "/apps"
Restart = "on-failure"
RestartSec = 5
ServiceEnable = true

# Dependencies
After = ["network.service", "nats.service"]
Before = []
Requires = ["nats.service"]
RequiredBy = []
```

#### Restart Policies

| Policy | Description |
|--------|-------------|
| `no` | Never restart |
| `always` | Always restart regardless of exit code |
| `on-failure` | Restart only on non-zero exit code |
| `on-success` | Restart only on zero exit code |

#### Control Interface

The init system exposes a JSON-RPC control interface:

```bash
# Via Unix socket
echo '{"ServiceList":{}}' | nc -U /run/init.sock

# Via VSOCK from host
echo '{"ServiceStart":{"name":"myservice"}}' | nc vsock:3:1234
```

#### Available Commands

- `Ping` / `Pong`
- `ListServices`
- `ServiceStatus { name }`
- `ServiceStart { name }`
- `ServiceStop { name }`
- `ServiceRestart { name }`
- `ServiceEnable { name }`
- `ServiceDisable { name }`
- `ServiceLogs { name, lines }`
- `ProcessList`
- `ProcessStart { command, args, env }`
- `ProcessStop { pid }`
- `SystemStatus`
- `SystemReload`
- `SystemShutdown`

---

### Enclave Engine

**Location**: `enclave-engine/`

High-level enclave provisioning and management API.

#### Features
- Enclave lifecycle management
- Configuration-based provisioning
- Nitro CLI integration
- Multi-enclave support

#### Configuration

**File**: `config.yaml`

```yaml
enclaves:
  default:
    cpu_count: 4
    memory_mb: 4096
    eif_path: "./enclave.eif"
    debug_mode: false
    cid: 127
```

---

## Reproducible Builds Build System (rbuilds)

**Location**: `rbuilds/`

Comprehensive build automation system for reproducible enclave images.

### Build Stages

| Stage | Command | Description |
|-------|---------|-------------|
| Nitro Setup | `make_nitro` | Install Nitro Enclaves CLI, configure allocator |
| Kernel | `make_kernel` | Build custom Linux kernel with NSM support |
| Apps | `make_apps` | Build Rust applications (Pipeline, ra-web-srv, etc.) |
| Init | `make_init` | Build init system (C, Go, or Rust variants) |
| EIF | `make_eif` | Assemble Enclave Image Format file |
| All | `make_all` | Full automated build pipeline |

### CLI Reference

```bash
# Full syntax
./rbuilds.sh [OPTIONS] --cmd "COMMAND"

# Options
--tty                    # Allocate TTY for interactive output
--debug                  # Enable verbose logging
--network                # Enable both forward and reverse proxy
--rev-net                # Enable reverse proxy only
--fw-net                 # Enable forward proxy only
--init-c                 # Use C init system
--init-go                # Use Go init system
--init-rs                # Use Rust init system
--kernel VERSION         # Specify kernel version (default: 6.14.5)
--memory SIZE            # Enclave memory in MiB (default: 838656)
--cpus COUNT             # Enclave CPU count (default: 64)
--cid VALUE              # VSOCK CID (default: 127)
--dockerfile FILE        # Custom dockerfile for rootfs
```

### Example Build Workflows

```bash
# Build with networking support
./rbuilds.sh --tty --debug --network --init-c \
  --dockerfile ./pipeline-slc-network-al2023.dockerfile \
  --cmd "make_all" 2>&1 3>&1

# Build individual stages
./rbuilds.sh --tty --debug --cmd "make_kernel" 2>&1 3>&1
./rbuilds.sh --tty --debug --cmd "make_apps" 2>&1 3>&1
./rbuilds.sh --tty --debug --cmd "make_init" 2>&1 3>&1
./rbuilds.sh --tty --debug --cmd "make_eif" 2>&1 3>&1

# Enclave management
./rbuilds.sh --cmd "run_eif_image_debugmode_cli" 2>&1 3>&1
./rbuilds.sh --cmd "list_enclaves" 2>&1 3>&1
./rbuilds.sh --cmd "attach_console_to_enclave" 2>&1 3>&1
./rbuilds.sh --cmd "drop_enclave" 2>&1 3>&1
./rbuilds.sh --cmd "drop_enclaves_all" 2>&1 3>&1

# Cleanup
./rbuilds.sh --cmd "make_clear" 2>&1 3>&1
```

### Interactive Mode

```bash
# Start interactive shell
./rbuilds.sh

# Commands at prompt
> help              # Show available commands
> make all          # Build everything
> list_enclaves     # List running enclaves
> q                 # Toggle confirmation prompts
> lsh               # Enable local shell commands
> exit              # Exit shell
```

### Automation Interface

```bash
# Pipe commands for automation
{ echo "make_kernel"; echo "make_apps"; } | ./rbuilds.sh 2>&1

# With logging
{ echo "make all"; } | /usr/bin/time -v -o ./build.log ./rbuilds.sh 2>&1 | tee ./build.output
```

---

## Configuration

### Directory Structure

```
/apps/
â”œâ”€â”€ .config/
â”‚   â”œâ”€â”€ pipeline.config.toml
â”‚   â”œâ”€â”€ ra_web_srv.config.toml
â”‚   â””â”€â”€ nats.config
â”œâ”€â”€ .logs/
â”œâ”€â”€ certs/
â”‚   â”œâ”€â”€ cert.pem
â”‚   â””â”€â”€ skey.pem
â”œâ”€â”€ pipeline
â”œâ”€â”€ ra-web-srv
â”œâ”€â”€ fs-monitor
â”œâ”€â”€ nats-server
â”œâ”€â”€ init.sh
â””â”€â”€ .fsignore
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `CERT_DIR` | TLS certificate directory | `./certs/` |
| `INIT_CONFIG` | Init system config path | `/etc/init.yaml` |
| `LOG_LEVEL` | Logging verbosity | `info` |

---

## Security

### Attestation Flow

1. **File Hashing**: SHA3-512 hash computed for target files
2. **VRF Proof Generation**: Deterministic proof using EC-VRF
3. **NSM Attestation**: Hardware-rooted attestation document from Nitro Security Module
4. **Certificate Validation**: Full X.509 chain verification against AWS root CA

### PCR Registers

| PCR | Description |
|-----|-------------|
| PCR0 | Enclave image hash |
| PCR1 | Linux kernel and bootstrap hash |
| PCR2 | Application hash |
| PCR3 | IAM role hash (if applicable) |
| PCR4 | Parent instance ID |
| PCR8 | Signing certificate hash |

### Supported Cipher Suites (VRF)

- `SECP256R1_SHA256_TAI` (default)
- `SECP384R1_SHA384_TAI`
- `SECP521R1_SHA512_TAI`
- `BRAINPOOL_P256R1_SHA256_TAI`
- And more...

---

## Troubleshooting

### Common Issues

#### "Missing configuration file" Error

```bash
# Create required config directories
mkdir -p .config/
cp pipeline/.config/pipeline.config.toml .config/
```

#### VSOCK Connection Refused

```bash
# Verify enclave is running
nitro-cli describe-enclaves

# Check Pipeline server is listening
./rbuilds.sh --cmd "attach_console_to_enclave"
# Look for "Pipeline listening on port 53000"
```

#### Enclave Won't Start

```bash
# Check allocator status
systemctl status nitro-enclaves-allocator

# Verify resource allocation
cat /etc/nitro_enclaves/allocator.yaml

# Check for enough memory/CPUs
free -h
nproc
```

#### PCR Mismatch

```bash
# Get expected PCRs from EIF build
cat ./eif/app-builder-secure-enclaves-framework.eif.pcr

# Compare with running enclave
curl -k https://127.0.0.1:8443/pcrs/
```

### Debug Mode

```bash
# Run enclave with debug console
./rbuilds.sh --debug --cmd "run_eif_image_debugmode_cli"

# View enclave debug output
nitro-cli console --enclave-name app_builder_secure_enclaves_framework_toolkit
```

### Logs

```bash
# Build logs
cat ./eif/make_build.log
cat ./eif/run-enclave.log

# Inside enclave
cat /apps/.logs/pipeline.log
cat /apps/.logs/ra-web-srv.log
cat /apps/.logs/fs-monitor.log
cat /apps/.logs/nats-server.log
```

---

## Development

### Building from Source

```bash
# Build all crates
cargo build --release

# Run tests
cargo test --all

# Build specific component
cargo build --release -p pipeline
cargo build --release -p ra-web-srv
cargo build --release -p fs-monitor
cargo build --release -p enclave-init
```

### Project Layout

```
secure-enclaves-framework/
â”œâ”€â”€ pipeline/           # Secure channel protocol
â”œâ”€â”€ pf-proxy/           # Port forwarding proxies
â”œâ”€â”€ ra-web-srv/         # Remote attestation server
â”œâ”€â”€ fs-monitor/         # File system monitoring
â”œâ”€â”€ enclave-init/       # Init system (Rust)
â”œâ”€â”€ enclave-engine/     # Enclave management API
â”œâ”€â”€ rbuilds/            # Build system
â”‚   â”œâ”€â”€ rbuilds.sh      # Main build script
â”‚   â”œâ”€â”€ init_apps/      # Init source (C, Go)
â”‚   â”œâ”€â”€ kernel_config/  # Kernel configurations
â”‚   â”œâ”€â”€ enclave.init/   # Runtime scripts
â”‚   â””â”€â”€ *.dockerfile    # Build dockerfiles
â””â”€â”€ docs/               # Documentation
```

---

## License

This project is licensed under the **Apache 2.0 License**. See the [`LICENSE-APACHE`](LICENSE-APACHE) file for the details.

---

## Support

For issues, questions, or contributions, please refer to the project repository:

- **Issue Tracker**: [GitHub Issues](https://github.com/sentient-agi/Sentient-Enclaves-Framework/issues)
- **Discussions**: [GitHub Discussions](https://github.com/sentient-agi/Sentient-Enclaves-Framework/discussions)
- **Documentation**: [GitHub Wiki](https://github.com/sentient-agi/Sentient-Enclaves-Framework/wiki)
- **Email**: Sentient Enclaves Team <sentient-enclaves-team@sentient.xyz>

---

## Contributing

Contributions are welcome!

### Getting Started

Please follow these guidelines:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/feature-name`)
3. Make your changes
4. Add tests
5. Run tests: `cargo test`
6. Run lints: `cargo clippy`
7. Commit changes (`git commit -am 'Add feature'`)
8. Push to branch (`git push origin feature/feature-name`)
9. Submit a Pull Request

### Code Style

- Follow Rust naming conventions
- Use `rustfmt` for formatting
- Add documentation for public APIs and new features
- Include tests for new functionality

Please ensure:

- Code follows Rust style guidelines (rustfmt)
- All tests pass
- New features include documentation
- Security implications are considered

### Pull Request Guidelines

- Clear description of changes
- Link to related issues
- Include test coverage
- Update documentation as needed

---

## Acknowledgments

- AWS Nitro Enclaves team for the underlying TEE infrastructure
- The Rust community for excellent cryptographic libraries
- Contributors to the VRF, COSE, and attestation standards

---

## Further Reading

- [AWS Nitro Enclaves Documentation](https://docs.aws.amazon.com/enclaves/)
- [VSOCK Protocol](https://man7.org/linux/man-pages/man7/vsock.7.html)
- [COSE (RFC 8152)](https://datatracker.ietf.org/doc/html/rfc8152)
- [VRF (RFC 9381)](https://datatracker.ietf.org/doc/html/rfc9381)

---

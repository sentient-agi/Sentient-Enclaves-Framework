# Confidential VM Architecture Diagrams

ASCII diagrams for Azure and GCP Confidential Virtual Machines with hardware-based Trusted Execution Environments (TEE).

---

## Table of Contents

- [Overview](#overview)
- [Azure Confidential VMs](#azure-confidential-vms)
  - [Architecture Overview](#azure-architecture-overview)
  - [Boot Sequence](#azure-boot-sequence)
  - [Attestation Flow](#azure-attestation-flow)
  - [Memory Protection](#azure-memory-protection)
  - [Confidential GPU (H100)](#azure-confidential-gpu)
- [GCP Confidential VMs](#gcp-confidential-vms)
  - [Architecture Overview](#gcp-architecture-overview)
  - [Boot Sequence (TDX)](#gcp-boot-sequence-tdx)
  - [Boot Sequence (SEV-SNP)](#gcp-boot-sequence-sev-snp)
  - [Attestation Flow](#gcp-attestation-flow)
  - [Memory Protection](#gcp-memory-protection)
- [Comparison](#comparison)

---

## Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CONFIDENTIAL COMPUTING STACK                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     YOUR APPLICATION                                │   │
│   │                   (No code changes needed)                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      GUEST OS (Linux/Windows)                       │   │
│   │                    vTPM │ Kernel │ Drivers                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│   ════════════════════════════════════════════════════════════════════════  │
│   ║            HARDWARE ENCRYPTION BOUNDARY (AES-256)                    ║  │
│   ║         Memory encrypted with key held only in CPU                   ║  │
│   ════════════════════════════════════════════════════════════════════════  │
│                                   │                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         HYPERVISOR                                  │   │
│   │              (Sees only ciphertext - excluded from TCB)             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │              AMD Secure Processor / Intel TDX Module                │   │
│   │                  (Hardware Root of Trust)                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Technology Comparison

```
┌──────────────────┬─────────────────────────┬─────────────────────────┐
│     Feature      │       AMD SEV-SNP       │       Intel TDX         │
├──────────────────┼─────────────────────────┼─────────────────────────┤
│ Isolation Level  │ Full VM                 │ Full VM (Trust Domain)  │
│ Memory Encrypt   │ AES-256 (per-VM key)    │ AES-128 (TME-MK)        │
│ Integrity        │ RMP (Reverse Map Table) │ SEPT + MAC              │
│ Attestation      │ VCEK (chip-unique)      │ ECDSA via SGX QE        │
│ Key Management   │ AMD Secure Processor    │ TDX Module (SEAM)       │
│ Page Tracking    │ RMP                     │ Secure EPT              │
│ Exception        │ #VC                     │ #VE                     │
└──────────────────┴─────────────────────────┴─────────────────────────┘
```

---

## Azure Confidential VMs

### Azure Architecture Overview

```
                            ┌──────────────────────────────────────┐
                            │           AZURE CLOUD                │
                            └──────────────────────────────────────┘
                                             │
            ┌────────────────────────────────┼────────────────────────────────┐
            │                                │                                │
            ▼                                ▼                                ▼
   ┌─────────────────┐            ┌─────────────────┐            ┌─────────────────┐
   │ Azure Resource  │            │     Azure       │            │   Azure Key     │
   │    Manager      │            │   Attestation   │            │     Vault       │
   └────────┬────────┘            └────────┬────────┘            └────────┬────────┘
            │                              │                              │
            │ 1. Create CVM                │ 4. Verify                    │ 6. Release
            │    DCasv5/ECasv5             │    Evidence                  │    Secrets
            ▼                              │                              │
   ┌────────────────────────────────────────────────────────────────────────────────┐
   │                              PHYSICAL HOST                                     │
   │  ┌──────────────────────────────────────────────────────────────────────────┐  │
   │  │                         AZURE HYPERVISOR                                 │  │
   │  │                    (Excluded from Trust Boundary)                        │  │
   │  └──────────────────────────────────────────────────────────────────────────┘  │
   │                                     │                                          │
   │        ┌────────────────────────────┴────────────────────────────┐             │
   │        │                                                         │             │
   │        ▼                                                         ▼             │
   │  ┌───────────────────────────────────┐   ┌───────────────────────────────┐     │
   │  │     AMD SECURE PROCESSOR          │   │      CONFIDENTIAL VM          │     │
   │  │  ┌─────────────────────────────┐  │   │  ┌─────────────────────────┐  │     │
   │  │  │ • Generate VM Key           │  │   │  │      Application        │  │     │
   │  │  │ • RMP Management            │◄─┼───┼─►│      Guest OS           │  │     │
   │  │  │ • Attestation Reports       │  │   │  │      vTPM               │  │     │
   │  │  │ • VCEK Signing              │  │   │  │      Encrypted Memory   │  │     │
   │  │  └─────────────────────────────┘  │   │  └─────────────────────────┘  │     │
   │  └───────────────────────────────────┘   └───────────────────────────────┘     │
   │                                                                                │
   │  ┌──────────────────────────────────────────────────────────────────────────┐  │
   │  │                    PHYSICAL RAM (Encrypted)                              │  │
   │  │    [████ VM1 ████][████ VM2 ████][████ VM3 ████]  ← Each VM has          │  │
   │  │     Key: K1         Key: K2         Key: K3         unique key           │  │
   │  └──────────────────────────────────────────────────────────────────────────┘  │
   └────────────────────────────────────────────────────────────────────────────────┘
```

### Azure Boot Sequence

```
┌─────────┐    ┌─────────┐    ┌──────────┐    ┌─────────┐     ┌─────────┐
│  User   │    │  Azure  │    │   Host   │    │ AMD SP  │     │   CVM   │
│         │    │   ARM   │    │          │    │         │     │         │
└────┬────┘    └────┬────┘    └────┬─────┘    └────┬────┘     └────┬────┘
     │              │              │               │               │
     │ 1. Create    │              │               │               │
     │    CVM       │              │               │               │
     │─────────────►│              │               │               │
     │              │              │               │               │
     │              │ 2. Allocate  │               │               │
     │              │    SEV-SNP   │               │               │
     │              │    Host      │               │               │
     │              │─────────────►│               │               │
     │              │              │               │               │
     │              │              │ 3. Request    │               │
     │              │              │    VM Key     │               │
     │              │              │──────────────►│               │
     │              │              │               │               │
     │              │              │               │──┐            │
     │              │              │               │  │ 4. Generate│
     │              │              │               │  │    AES-256 │
     │              │              │               │  │    Key     │
     │              │              │               │◄─┘            │
     │              │              │               │               │
     │              │              │               │ 5. Init RMP   │
     │              │              │               │    (Reverse   │
     │              │              │               │    Map Table) │
     │              │              │               │──┐            │
     │              │              │               │◄─┘            │
     │              │              │               │               │
     │              │              │               │ 6. Create     │
     │              │              │               │    Encrypted  │
     │              │              │               │    Memory     │
     │              │              │               │──────────────►│
     │              │              │               │               │
     │              │              │               │               │──┐
     │              │              │               │               │  │ 7. UEFI
     │              │              │               │               │  │    Secure
     │              │              │               │               │  │    Boot
     │              │              │               │               │◄─┘
     │              │              │               │               │
     │              │              │               │               │──┐
     │              │              │               │               │  │ 8. Init
     │              │              │               │               │  │    vTPM
     │              │              │               │               │◄─┘
     │              │              │               │               │
     │              │              │               │               │──┐
     │              │              │               │               │  │ 9. Boot
     │              │              │               │               │  │    Guest
     │              │              │               │               │  │    OS
     │              │              │               │               │◄─┘
     │              │              │               │               │
     │◄════════════════════════════════════════════════════════════│
     │                    10. VM Ready (SSH/RDP)                   │
     │                                                             │
```

### Azure Attestation Flow

```
┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
│   App   │   │  Guest  │   │ AMD SP  │   │ Azure   │   │ AMD KDS │   │  Key    │
│         │   │   OS    │   │         │   │ Attest  │   │         │   │  Vault  │
└────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘
     │             │             │             │             │             │
     │ 1. Request  │             │             │             │             │
     │    Attest   │             │             │             │             │
     │────────────►│             │             │             │             │
     │             │             │             │             │             │
     │             │ 2. SNP_GUEST│             │             │             │
     │             │    _REQUEST │             │             │             │
     │             │────────────►│             │             │             │
     │             │             │             │             │             │
     │             │             │──┐          │             │             │
     │             │             │  │ 3. Collect Measurements:             │
     │             │             │  │    • Launch Digest     │             │
     │             │             │  │    • Guest Policy      │             │
     │             │             │  │    • Platform Info     │             │
     │             │             │  │    • TCB Version       │             │
     │             │             │◄─┘          │             │             │
     │             │             │             │             │             │
     │             │             │──┐          │             │             │
     │             │             │  │ 4. Sign with VCEK      │             │
     │             │             │  │    (Chip-unique key)   │             │
     │             │             │◄─┘          │             │             │
     │             │             │             │             │             │
     │             │◄────────────│             │             │             │
     │             │  5. SNP Report            │             │             │
     │             │             │             │             │             │
     │             │ 6. Submit   │             │             │             │
     │             │    Report   │             │             │             │
     │             │────────────────────────►  │             │             │
     │             │             │             │             │             │
     │             │             │             │ 7. Fetch    │             │
     │             │             │             │    VCEK Cert│             │
     │             │             │             │────────────►│             │
     │             │             │             │             │             │
     │             │             │             │◄────────────│             │
     │             │             │             │  8. AMD Root CA           │
     │             │             │             │     → VCEK Chain          │
     │             │             │             │             │             │
     │             │             │             │──┐          │             │
     │             │             │             │  │ 9. Verify Signature    │
     │             │             │             │  │    Validate Policy     │
     │             │             │             │  │    Check TCB Version   │
     │             │             │             │◄─┘          │             │
     │             │             │             │             │             │
     │             │◄────────────────────────────            │             │
     │             │  10. JWT Attestation Token              │             │
     │             │             │             │             │             │
     │             │ 11. Request Secrets (JWT) │             │             │
     │             │──────────────────────────────────────────────────────►│
     │             │             │             │             │             │
     │             │             │             │             │             │──┐
     │             │             │             │             │             │  │12. Verify
     │             │             │             │             │             │  │   JWT
     │             │             │             │             │             │◄─┘
     │             │             │             │             │             │
     │◄────────────────────────────────────────────────────────────────────│
     │                         13. Release Encryption Keys                 │
     │                                                                     │
```

### Azure Memory Protection

```
                    MEMORY ACCESS PATTERNS
    ════════════════════════════════════════════════════════

    LEGITIMATE ACCESS (From inside CVM)
    ────────────────────────────────────

    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │ Application │      │     MMU     │      │     RMP     │
    │  (in CVM)   │      │             │      │   Check     │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
           │                    │                    │
           │ 1. Read 0x1000     │                    │
           │───────────────────►│                    │
           │                    │                    │
           │                    │ 2. VA → PA         │
           │                    │    Translation     │
           │                    │───────────────────►│
           │                    │                    │
           │                    │    3. Page owned   │
           │                    │◄───────────────────│
           │                    │       by VM ✓      │
           │                    │                    │
           │                    ▼                    │
           │            ┌─────────────┐              │
           │            │  Memory     │              │
           │            │  Encryption │              │
           │            │  Engine     │              │
           │            └──────┬──────┘              │
           │                   │                     │
           │                   │ 4. Read RAM         │
           │                   ▼                     │
           │            ┌─────────────┐              │
           │            │ Physical    │              │
           │            │ RAM         │              │
           │            │ [Encrypted] │              │
           │            └──────┬──────┘              │
           │                   │                     │
           │                   │ 5. Ciphertext       │
           │                   ▼                     │
           │            ┌─────────────┐              │
           │            │  Decrypt    │              │
           │            │  with VM    │              │
           │            │  Key        │              │
           │            └──────┬──────┘              │
           │                   │                     │
           │◄──────────────────┘                     │
           │  6. Plaintext Data ✓                    │
           │                                         │


    MALICIOUS ACCESS (From Hypervisor)
    ───────────────────────────────────

    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │ Hypervisor  │      │ Physical    │      │     RMP     │
    │  (Attacker) │      │ RAM         │      │             │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
           │                    │                    │
           │ 1. Direct Read     │                    │
           │    0xABCD000       │                    │
           │───────────────────►│                    │
           │                    │                    │
           │◄───────────────────│                    │
           │  2. Ciphertext ✗   │                    │
           │     (No Key!)      │                    │
           │                    │                    │
           │ 3. Try to Remap    │                    │
           │    Page            │                    │
           │────────────────────────────────────────►│
           │                    │                    │
           │◄────────────────────────────────────────│
           │  4. DENIED ✗       │                    │
           │     Page is Private│                    │
           │     #VC Exception  │                    │
           │                    │                    │


    MEMORY LAYOUT
    ─────────────

    ┌───────────────────────────────────────────────────────────┐
    │                    PHYSICAL RAM                           │
    ├───────────────────────────────────────────────────────────┤
    │                                                           │
    │  ┌──────────────────┐  ┌──────────────────┐               │
    │  │ CVM 1 Memory     │  │ CVM 2 Memory     │               │
    │  │ ┌──────────────┐ │  │ ┌──────────────┐ │               │
    │  │ │██████████████│ │  │ │▓▓▓▓▓▓▓▓▓▓▓▓▓▓│ │               │
    │  │ │██ Encrypted █│ │  │ │▓▓ Encrypted ▓│ │               │
    │  │ │██  Key: K1  █│ │  │ │▓▓  Key: K2  ▓│ │               │
    │  │ │██████████████│ │  │ │▓▓▓▓▓▓▓▓▓▓▓▓▓▓│ │               │
    │  │ └──────────────┘ │  │ └──────────────┘ │               │
    │  │   RMP: Private   │  │   RMP: Private   │               │
    │  └──────────────────┘  └──────────────────┘               │
    │                                                           │
    │  ┌──────────────────────────────────────────┐             │
    │  │ Hypervisor Memory (Shared)               │             │
    │  │ [Unencrypted - No secrets here]          │             │
    │  │   RMP: Shared                            │             │
    │  └──────────────────────────────────────────┘             │
    │                                                           │
    └───────────────────────────────────────────────────────────┘
```

### Azure Confidential GPU

```
    CONFIDENTIAL GPU ARCHITECTURE (NCC H100 v5)
    ════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────────────────────┐
    │                        CONFIDENTIAL VM (CPU TEE)                    │
    │  ┌───────────────────────────────────────────────────────────────┐  │
    │  │                      AI/ML Application                        │  │
    │  │                    (PyTorch, TensorFlow)                      │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │  ┌───────────────────────────────▼───────────────────────────────┐  │
    │  │                     NVIDIA Driver (in TEE)                    │  │
    │  │              Manages secure communication with GPU            │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │  ┌───────────────────────────────▼───────────────────────────────┐  │
    │  │                   Encrypted Bounce Buffer                     │  │
    │  │                  (Shared memory region)                       │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │                     AMD SEV-SNP Protected Memory                    │
    └──────────────────────────────────┼──────────────────────────────────┘
                                       │
                          ═════════════╪═════════════
                          ║   PCIe Bus (Encrypted)  ║
                          ║   AES-GCM + SPDM        ║
                          ═════════════╪═════════════
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────┐
    │                                  │                                  │
    │                       NVIDIA H100 GPU TEE                           │
    │                                  │                                  │
    │  ┌───────────────────────────────▼───────────────────────────────┐  │
    │  │                    On-Die Root of Trust                       │  │
    │  │              • Session Key Generation                         │  │
    │  │              • Attestation Report Signing                     │  │
    │  │              • Firmware Verification                          │  │
    │  └───────────────────────────────┬───────────────────────────────┘  │
    │                                  │                                  │
    │  ┌───────────────────────────────▼───────────────────────────────┐  │
    │  │                    Encrypted HBM3 (94GB)                      │  │
    │  │  ┌─────────────────────────────────────────────────────────┐  │  │
    │  │  │  █████████████████████████████████████████████████████  │  │  │
    │  │  │  ██  Model Weights  ██  Activations  ██  Gradients  ██  │  │  │
    │  │  │  █████████████████████████████████████████████████████  │  │  │
    │  │  │              (Hardware-encrypted)                       │  │  │
    │  │  └─────────────────────────────────────────────────────────┘  │  │
    │  └───────────────────────────────────────────────────────────────┘  │
    │                                                                     │
    │  ┌───────────────────────────────────────────────────────────────┐  │
    │  │                     CUDA Compute Cores                        │  │
    │  │                   (Process encrypted data)                    │  │
    │  └───────────────────────────────────────────────────────────────┘  │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘


    DATA FLOW SEQUENCE
    ──────────────────

    ┌───────┐    ┌────────┐    ┌────────┐    ┌───────┐    ┌───────┐
    │  App  │    │ Driver │    │ Bounce │    │ PCIe  │    │  GPU  │
    └───┬───┘    └───┬────┘    └───┬────┘    └───┬───┘    └───┬───┘
        │            │             │             │            │
        │ 1. cudaMemcpy            │             │            │
        │───────────►│             │             │            │
        │            │             │             │            │
        │            │ 2. Encrypt  │             │            │
        │            │    (AES-GCM)│             │            │
        │            │────────────►│             │            │
        │            │             │             │            │
        │            │             │ 3. Transfer │            │
        │            │             │    Cipher   │            │
        │            │             │────────────►│            │
        │            │             │             │            │
        │            │             │             │ 4. Verify  │
        │            │             │             │    & Decrypt
        │            │             │             │───────────►│
        │            │             │             │            │
        │            │             │             │            │──┐
        │            │             │             │            │  │5. Process
        │            │             │             │            │  │  in HBM
        │            │             │             │            │◄─┘
        │            │             │             │            │
        │◄════════════════════════════════════════════════════│
        │           6. Return Encrypted Results               │
        │                                                     │


    ATTESTATION (CPU + GPU)
    ───────────────────────

    ┌────────────────────────────────────────────────────────┐
    │                 COMBINED ATTESTATION                   │
    │                                                        │
    │   ┌─────────────────┐       ┌─────────────────┐        │
    │   │ CPU Attestation │       │ GPU Attestation │        │
    │   │    Report       │       │    Report       │        │
    │   │                 │       │                 │        │
    │   │ • SEV-SNP       │       │ • GPU RoT       │        │
    │   │ • Launch Digest │       │ • Firmware Ver  │        │
    │   │ • TCB Version   │       │ • CC Mode: ON   │        │
    │   │ • VCEK Signed   │       │ • ECC Signed    │        │
    │   └────────┬────────┘       └────────┬────────┘        │
    │            │                         │                 │
    │            └───────────┬─────────────┘                 │
    │                        │                               │
    │                        ▼                               │
    │            ┌───────────────────────┐                   │
    │            │   Verifier Service    │                   │
    │            │  (Azure Attestation)  │                   │
    │            └───────────────────────┘                   │
    │                        │                               │
    │                        ▼                               │
    │            ┌───────────────────────┐                   │
    │            │  Joint Trust Token    │                   │
    │            │  (Both TEEs Valid)    │                   │
    │            └───────────────────────┘                   │
    │                                                        │
    └────────────────────────────────────────────────────────┘
```

---

## GCP Confidential VMs

### GCP Architecture Overview

```
                            ┌──────────────────────────────────────┐
                            │         GOOGLE CLOUD                 │
                            └──────────────────────────────────────┘
                                             │
            ┌────────────────────────────────┼────────────────────────────────┐
            │                                │                                │
            ▼                                ▼                                ▼
   ┌─────────────────┐            ┌─────────────────┐            ┌─────────────────┐
   │ Compute Engine  │            │  Google Cloud   │            │    Cloud        │
   │      API        │            │  Attestation    │            │     KMS         │
   └────────┬────────┘            └────────┬────────┘            └────────┬────────┘
            │                              │                              │
            │                              │                              │
            ▼                              │                              │
   ┌────────────────────────────────────────────────────────────────────────────────┐
   │                              PHYSICAL HOST                                     │
   │                                                                                │
   │  ┌──────────────────────────────────────────────────────────────────────────┐  │
   │  │                        GOOGLE TITANIUM                                   │  │
   │  │                  (Hardware Security Chip)                                │  │
   │  │              • Host Integrity Verification                               │  │
   │  │              • Firmware Authentication                                   │  │
   │  └──────────────────────────────────────────────────────────────────────────┘  │
   │                                     │                                          │
   │  ┌──────────────────────────────────────────────────────────────────────────┐  │
   │  │                         KVM HYPERVISOR                                   │  │
   │  │                    (Excluded from Trust Boundary)                        │  │
   │  └──────────────────────────────────────────────────────────────────────────┘  │
   │                                     │                                          │
   │        ┌────────────────────────────┴────────────────────────────┐             │
   │        │                                                         │             │
   │        ▼                                                         ▼             │
   │  ┌───────────────────────────────────┐   ┌───────────────────────────────┐     │
   │  │  HARDWARE SECURITY MODULE         │   │      CONFIDENTIAL VM          │     │
   │  │  ┌─────────────────────────────┐  │   │  ┌─────────────────────────┐  │     │
   │  │  │ AMD SEV-SNP:                │  │   │  │      Application        │  │     │
   │  │  │  • AMD Secure Processor     │  │   │  │      Guest OS           │  │     │
   │  │  │  • VCEK Attestation         │◄─┼───┼─►│      vTPM               │  │     │
   │  │  │                             │  │   │  │      Encrypted Memory   │  │     │
   │  │  │ Intel TDX:                  │  │   │  │                         │  │     │
   │  │  │  • TDX Module (SEAM)        │  │   │  │  td_guest / sev_guest   │  │     │
   │  │  │  • Quoting Enclave          │  │   │  │  modules loaded         │  │     │
   │  │  └─────────────────────────────┘  │   │  └─────────────────────────┘  │     │
   │  └───────────────────────────────────┘   └───────────────────────────────┘     │
   │                                                                                │
   └────────────────────────────────────────────────────────────────────────────────┘


    SUPPORTED CONFIGURATIONS
    ────────────────────────

    ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
    │   Technology    │  Machine Type   │      CPU        │    Features     │
    ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
    │   AMD SEV       │ N2D, C2D, C3D   │ EPYC Milan      │ Memory Encrypt  │
    │                 │ C4D             │ EPYC Genoa      │ vTPM (managed)  │
    ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
    │   AMD SEV-SNP   │ N2D             │ EPYC Milan+     │ + Integrity     │
    │                 │                 │                 │ + HW Attestation│
    ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
    │   Intel TDX     │ C3              │ Xeon Sapphire   │ + Integrity     │
    │                 │                 │ Rapids          │ + HW Attestation│
    ├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
    │   Conf. GPU     │ A3              │ + H100 GPU      │ + GPU TEE       │
    └─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

### GCP Boot Sequence (TDX)

```
┌─────────┐    ┌─────────┐    ┌──────────┐   ┌─────────┐    ┌─────────┐
│  User   │    │   GCE   │    │ Titanium │   │   TDX   │    │   TD    │
│         │    │   API   │    │          │   │ Module  │    │ (CVM)   │
└────┬────┘    └────┬────┘    └────┬─────┘   └────┬────┘    └────┬────┘
     │              │              │              │              │
     │ 1. Create    │              │              │              │
     │    CVM (C3)  │              │              │              │
     │─────────────►│              │              │              │
     │              │              │              │              │
     │              │ 2. Verify    │              │              │
     │              │    Host      │              │              │
     │              │─────────────►│              │              │
     │              │              │              │              │
     │              │◄─────────────│              │              │
     │              │  3. Host OK ✓│              │              │
     │              │              │              │              │
     │              │ 4. SEAMCALL: │              │              │
     │              │    Create TD │              │              │
     │              │────────────────────────────►│              │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 5. Enter  │
     │              │              │              │  │    SEAM   │
     │              │              │              │  │    Mode   │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 6. Generate
     │              │              │              │  │    TD Key │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 7. Init   │
     │              │              │              │  │    TDCS & │
     │              │              │              │  │    SEPT   │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │              │ 8. Allocate  │
     │              │              │              │    Encrypted │
     │              │              │              │    Pages     │
     │              │              │              │─────────────►│
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │ 9. Load
     │              │              │              │              │  │   Signed
     │              │              │              │              │  │   UEFI
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │10. Measure
     │              │              │              │              │  │   → MRTD
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │11. Init
     │              │              │              │              │  │   vTPM
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │12. Boot
     │              │              │              │              │  │   Linux
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │◄══════════════════════════════════════════════════════════│
     │                     13. VM Ready ✓                        │
     │                                                           │
```

### GCP Boot Sequence (SEV-SNP)

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  User   │    │   GCE   │    │   KVM   │    │ AMD SP  │    │   CVM   │
└────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘
     │              │              │              │              │
     │ 1. Create    │              │              │              │
     │    CVM (N2D) │              │              │              │
     │─────────────►│              │              │              │
     │              │              │              │              │
     │              │ 2. Select    │              │              │
     │              │    SNP Host  │              │              │
     │              │─────────────►│              │              │
     │              │              │              │              │
     │              │              │ 3. SNP_      │              │
     │              │              │    LAUNCH_   │              │
     │              │              │    START     │              │
     │              │              │─────────────►│              │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 4. Create │
     │              │              │              │  │    GCTX   │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 5. Derive │
     │              │              │              │  │    VM Key │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │ 6. SNP_      │              │
     │              │              │    LAUNCH_   │              │
     │              │              │    UPDATE    │              │
     │              │              │    (pages)   │              │
     │              │              │─────────────►│              │
     │              │              │              │              │
     │              │              │              │──┐           │
     │              │              │              │  │ 7. Encrypt│
     │              │              │              │  │    & Hash │
     │              │              │              │  │    Pages  │
     │              │              │              │◄─┘           │
     │              │              │              │              │
     │              │              │ 8. SNP_      │              │
     │              │              │    LAUNCH_   │              │
     │              │              │    FINISH    │              │
     │              │              │─────────────►│              │
     │              │              │              │              │
     │              │              │◄─────────────│              │
     │              │              │  9. ID Block │              │
     │              │              │              │              │
     │              │              │              │ 10. Start    │
     │              │              │              │     Guest    │
     │              │              │              │─────────────►│
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │11. Google
     │              │              │              │              │  │   Signed
     │              │              │              │              │  │   UEFI
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │              │              │              │              │──┐
     │              │              │              │              │  │12. Boot
     │              │              │              │              │  │   OS
     │              │              │              │              │◄─┘
     │              │              │              │              │
     │◄══════════════════════════════════════════════════════════│
     │                     13. VM Ready ✓                        │
     │                                                           │
```

### GCP Attestation Flow

```
    INTEL TDX ATTESTATION
    ─────────────────────

┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
│   App   │   │   TD    │   │   TDX   │   │Quoting  │   │  Intel  │   │  Cloud  │
│         │   │  Guest  │   │ Module  │   │Enclave  │   │  Trust  │   │   KMS   │
│         │   │         │   │         │   │  (SGX)  │   │Authority│   │         │
└────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘
     │             │             │             │             │             │
     │ 1. Request  │             │             │             │             │
     │    Attest   │             │             │             │             │
     │────────────►│             │             │             │             │
     │             │             │             │             │             │
     │             │ 2. TDCALL   │             │             │             │
     │             │[TDG.MR.     │             │             │             │
     │             │ REPORT]     │             │             │             │
     │             │────────────►│             │             │             │
     │             │             │             │             │             │
     │             │             │──┐          │             │             │
     │             │             │  │ 3. Collect Measurements:             │
     │             │             │  │    • MRTD (launch)     │             │
     │             │             │  │    • RTMR[0-3] (runtime)             │
     │             │             │  │    • MRCONFIGID        │             │
     │             │             │  │    • MROWNER           │             │
     │             │             │◄─┘          │             │             │
     │             │             │             │             │             │
     │             │             │──┐          │             │             │
     │             │             │  │ 4. Sign with           │             │
     │             │             │  │    TDX Report Key      │             │
     │             │             │◄─┘          │             │             │
     │             │             │             │             │             │
     │             │◄────────────│             │             │             │
     │             │  5. TD Report             │             │             │
     │             │             │             │             │             │
     │             │ 6. Request  │             │             │             │
     │             │    Quote    │             │             │             │
     │             │    (via VMM)│             │             │             │
     │             │──────────────────────────►│             │             │
     │             │             │             │             │             │
     │             │             │             │──┐          │             │
     │             │             │             │  │ 7. Verify TD Report    │
     │             │             │             │  │    Sign with ECDSA     │
     │             │             │             │  │    Attestation Key     │
     │             │             │             │◄─┘          │             │
     │             │             │             │             │             │
     │             │◄──────────────────────────│             │             │
     │             │  8. TD Quote (ECDSA signed)             │             │
     │             │             │             │             │             │
     │             │ 9. Submit Quote           │             │             │
     │             │────────────────────────────────────────►│             │
     │             │             │             │             │             │
     │             │             │             │             │──┐          │
     │             │             │             │             │  │10. Verify│
     │             │             │             │             │  │   Signature
     │             │             │             │             │  │   & Policy
     │             │             │             │             │◄─┘          │
     │             │             │             │             │             │
     │             │◄────────────────────────────────────────│             │
     │             │  11. Attestation Token                  │             │
     │             │             │             │             │             │
     │             │ 12. Request Secrets (Token)             │             │
     │             │──────────────────────────────────────────────────────►│
     │             │             │             │             │             │
     │◄────────────────────────────────────────────────────────────────────│
     │                    13. Release Secrets ✓                            │
     │                                                                     │


    AMD SEV-SNP ATTESTATION (GCP)
    ─────────────────────────────

┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
│   App   │   │  Guest  │   │ AMD SP  │   │   GCP   │   │   KMS   │
│         │   │   OS    │   │         │   │ Attest  │   │         │
└────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘
     │             │             │             │             │
     │ 1. sevguest │             │             │             │
     │    get-report             │             │             │
     │────────────►│             │             │             │
     │             │             │             │             │
     │             │ 2. SNP_GUEST│             │             │
     │             │    _REQUEST │             │             │
     │             │────────────►│             │             │
     │             │             │             │             │
     │             │             │──┐          │             │
     │             │             │  │ 3. Generate Report     │
     │             │             │  │    Sign with VCEK      │
     │             │             │◄─┘          │             │
     │             │             │             │             │
     │             │◄────────────│             │             │
     │             │  4. SNP Report            │             │
     │             │     (VCEK Signed)         │             │
     │             │             │             │             │
     │             │ 5. Submit for Verification│             │
     │             │──────────────────────────►│             │
     │             │             │             │             │
     │             │             │             │──┐          │
     │             │             │             │  │ 6. Verify│
     │             │             │             │  │   Chain  │
     │             │             │             │  │   & Policy
     │             │             │             │◄─┘          │
     │             │             │             │             │
     │             │◄──────────────────────────│             │
     │             │  7. Attestation Result    │             │
     │             │             │             │             │
     │             │ 8. Request Secrets        │             │
     │             │────────────────────────────────────────►│
     │             │             │             │             │
     │◄──────────────────────────────────────────────────────│
     │             9. Secrets Released ✓       │             │
     │                                         │             │
```

### GCP Memory Protection

```
    INTEL TDX MEMORY PROTECTION
    ═══════════════════════════

    LEGITIMATE ACCESS (From inside TD)
    ──────────────────────────────────

    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │     TD      │      │    TDX      │      │   TME-MK    │
    │ Application │      │   Module    │      │   Engine    │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
           │                    │                    │
           │ 1. Memory Access   │                    │
           │───────────────────►│                    │
           │                    │                    │
           │                    │ 2. SEPT Walk       │
           │                    │    (Secure EPT)    │
           │                    │───┐                │
           │                    │◄──┘                │
           │                    │                    │
           │                    │ 3. Page owned by   │
           │                    │    this TD ✓       │
           │                    │                    │
           │                    │ 4. Request decrypt │
           │                    │    (TD's KeyID)    │
           │                    │───────────────────►│
           │                    │                    │
           │                    │                    │ 5. AES-XTS
           │                    │                    │    Decrypt
           │                    │                    │───┐
           │                    │                    │◄──┘
           │                    │                    │
           │◄────────────────────────────────────────│
           │  6. Plaintext Data ✓                    │
           │                                         │


    VMM ACCESS ATTEMPT (Blocked)
    ────────────────────────────

    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
    │     VMM     │      │    TDX      │      │   Memory    │
    │ (Hypervisor)│      │   Module    │      │             │
    └──────┬──────┘      └──────┬──────┘      └──────┬──────┘
           │                    │                    │
           │ 1. Direct Read     │                    │
           │────────────────────────────────────────►│
           │                    │                    │
           │◄────────────────────────────────────────│
           │  2. Ciphertext Only ✗                   │
           │     (No KeyID Access)                   │
           │                    │                    │
           │ 3. EPT Modify      │                    │
           │    Attempt         │                    │
           │───────────────────►│                    │
           │                    │                    │
           │                    │───┐                │
           │                    │   │ 4. Check SEPT  │
           │                    │◄──┘                │
           │                    │                    │
           │◄───────────────────│                    │
           │  5. #VE Exception ✗│                    │
           │     Access Denied  │                    │
           │                    │                    │


    MEMORY INTEGRITY CHECK
    ──────────────────────

    ┌────────────────────────────────────────────────────────────┐
    │                     TDX INTEGRITY FLOW                     │
    │                                                            │
    │   ┌─────────────┐                                          │
    │   │  TD Access  │                                          │
    │   └──────┬──────┘                                          │
    │          │                                                 │
    │          ▼                                                 │
    │   ┌─────────────┐     ┌─────────────┐                      │
    │   │  Read Page  │────►│ Verify MAC  │                      │
    │   └─────────────┘     └──────┬──────┘                      │
    │                              │                             │
    │              ┌───────────────┴───────────────┐             │
    │              │                               │             │
    │              ▼                               ▼             │
    │   ┌─────────────────┐             ┌─────────────────┐      │
    │   │   MAC Valid ✓   │             │  MAC Invalid ✗  │      │
    │   │                 │             │                 │      │
    │   │  Allow Access   │             │  TERMINATE TD   │      │
    │   │  Return Data    │             │  Security Alert │      │
    │   └─────────────────┘             └─────────────────┘      │
    │                                                            │
    └────────────────────────────────────────────────────────────┘


    KEY HIERARCHY
    ─────────────

    ┌─────────────────────────────────────────────────────────────┐
    │                                                             │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              Intel Platform Key                     │   │
    │   │           (Fused in CPU - Never Exported)           │   │
    │   └───────────────────────┬─────────────────────────────┘   │
    │                           │                                 │
    │                           ▼                                 │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              TME-MK Key Table                       │   │
    │   │         (Multiple KeyIDs Available)                 │   │
    │   └───────────────────────┬─────────────────────────────┘   │
    │                           │                                 │
    │           ┌───────────────┼───────────────┐                 │
    │           │               │               │                 │
    │           ▼               ▼               ▼                 │
    │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
    │   │  KeyID: 1   │ │  KeyID: 2   │ │  KeyID: 3   │           │
    │   │   TD #1     │ │   TD #2     │ │   TD #3     │           │
    │   └─────────────┘ └─────────────┘ └─────────────┘           │
    │                                                             │
    │   Each TD gets unique KeyID - keys never leave CPU          │
    │                                                             │
    └─────────────────────────────────────────────────────────────┘
```

---

## Comparison

### Side-by-Side Feature Matrix

```
┌────────────────────────┬──────────────────────────┬──────────────────────────┐
│        Feature         │      Azure CVMs          │       GCP CVMs           │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ AMD SEV (Basic)        │          ✗               │      ✓ (N2D, C2D)        │
│ AMD SEV-SNP            │      ✓ (DCasv5)          │      ✓ (N2D)             │
│ Intel TDX              │      ✓ (DCesv5)          │      ✓ (C3)              │
│ Intel SGX              │      ✓ (DCsv3)           │          ✗               │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ Confidential GPU       │      ✓ (H100)            │      ✓ (H100)            │
│ GPU SKU                │      NCC H100 v5         │      A3                  │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ Memory Encryption      │      AES-256             │      AES-128/256         │
│ Memory Integrity       │      ✓ (SNP/TDX)         │      ✓ (SNP/TDX)         │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ vTPM                   │      HW-Protected        │      Google-managed      │
│                        │      (in TEE)            │      or HW-backed        │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ OS Disk Encryption     │      Confidential        │      Standard +          │
│                        │      (PMK/CMK)           │      vTPM sealing        │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ Attestation Service    │      Azure Attestation   │      GCP Attestation     │
│                        │      Intel Trust Auth    │      Intel Trust Auth    │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ Firmware Signing       │      Microsoft           │      Google              │
│ Launch Measurement     │      ✓                   │      ✓ (Signed)          │
├────────────────────────┼──────────────────────────┼──────────────────────────┤
│ Hypervisor in TCB      │      ✗ (Excluded)        │      ✗ (Excluded)        │
│ Code Changes Needed    │      None                │      None                │
└────────────────────────┴──────────────────────────┴──────────────────────────┘
```

### Boot Sequence Timeline

```
    AZURE (AMD SEV-SNP)                      GCP (Intel TDX)
    ───────────────────                      ───────────────

    T+0ms   ┌─────────────────┐              T+0ms   ┌─────────────────┐
            │ AMD SP: Gen Key │                      │ TDX: Create TD  │
            └────────┬────────┘                      └────────┬────────┘
                     │                                        │
    T+100ms ┌────────▼────────┐              T+100ms ┌────────▼────────┐
            │ RMP Initialize  │                      │ SEAM Mode Init  │
            └────────┬────────┘                      └────────┬────────┘
                     │                                        │
    T+500ms ┌────────▼────────┐              T+400ms ┌────────▼────────┐
            │ UEFI Secure Boot│                      │ Load Signed UEFI│
            └────────┬────────┘                      └────────┬────────┘
                     │                                        │
    T+2s    ┌────────▼────────┐              T+1.5s  ┌────────▼────────┐
            │ vTPM Init + PCRs│                      │ vTPM + MRTD     │
            └────────┬────────┘                      └────────┬────────┘
                     │                                        │
    T+15s   ┌────────▼────────┐              T+12s   ┌────────▼────────┐
            │ Guest OS Ready  │                      │ Guest OS Ready  │
            └────────┬────────┘                      └────────┬────────┘
                     │                                        │
    T+16s   ┌────────▼────────┐              T+13s   ┌────────▼────────┐
            │ Attestation     │                      │ Attestation     │
            │ (Azure + VCEK)  │                      │ (ITA + QE)      │
            └─────────────────┘                      └─────────────────┘
```

### Trust Boundary Comparison

```
    ┌─────────────────────────────────────────────────────────────────────┐
    │                     TRUST BOUNDARY COMPARISON                       │
    ├─────────────────────────────────────────────────────────────────────┤
    │                                                                     │
    │   TRADITIONAL VM                    CONFIDENTIAL VM                 │
    │   ──────────────                    ───────────────                 │
    │                                                                     │
    │   ┌─────────────────┐               ┌─────────────────┐             │
    │   │   Application   │               │   Application   │ ◄── TCB     │
    │   ├─────────────────┤               ├─────────────────┤             │
    │   │    Guest OS     │               │    Guest OS     │ ◄── TCB     │
    │   ├─────────────────┤               ├─────────────────┤             │
    │   │     vTPM        │               │     vTPM        │ ◄── TCB     │
    │   ├─────────────────┤               ╞═════════════════╡             │
    │   │   Hypervisor    │ ◄── Trusted   ║   Hypervisor    ║ ◄── NOT     │
    │   ├─────────────────┤               ╞═════════════════╡    Trusted  │
    │   │  Host Firmware  │ ◄── Trusted   ║  Host Firmware  ║ ◄── NOT     │
    │   ├─────────────────┤               ╞═════════════════╡    Trusted  │
    │   │ Cloud Operator  │ ◄── Trusted   ║ Cloud Operator  ║ ◄── NOT     │
    │   └─────────────────┘               ╚═════════════════╝    Trusted  │
    │                                                                     │
    │   TCB includes:                     TCB includes:                   │
    │   • Application                     • Application                   │
    │   • Guest OS                        • Guest OS                      │
    │   • Hypervisor                      • CPU Hardware                  │
    │   • Host OS                         • AMD SP / TDX Module           │
    │   • Cloud Operator                                                  │
    │                                                                     │
    │   ════════════════════════════════════════════════════════════════  │
    │   ║ KEY DIFFERENCE: CVM removes hypervisor & cloud operator      ║  │
    │   ║ from the trust boundary. They see only encrypted memory.     ║  │
    │   ════════════════════════════════════════════════════════════════  │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
```

---

## References

- [AMD SEV-SNP Whitepaper](https://www.amd.com/system/files/TechDocs/SEV-SNP-strengthening-vm-isolation-with-integrity-protection-and-more.pdf)
- [Intel TDX Documentation](https://www.intel.com/content/www/us/en/developer/tools/trust-domain-extensions/documentation.html)
- [Azure Confidential Computing](https://learn.microsoft.com/en-us/azure/confidential-computing/)
- [GCP Confidential Computing](https://cloud.google.com/confidential-computing/confidential-vm/docs)
- [NVIDIA Confidential Computing](https://developer.nvidia.com/blog/confidential-computing-on-h100-gpus-for-secure-and-trustworthy-ai/)

---

## License

This documentation is provided for educational and informational purposes. Architecture diagrams and attestation flow diagrams are based on publicly available documentation from AMD, Intel, NVidia, Microsoft Azure, and Google Cloud Platform.

This project documentation is licensed under the **Apache 2.0 License**. See the [`LICENSE-APACHE`](LICENSE-APACHE) file for the details.

---

*Last Updated: January 2026*
